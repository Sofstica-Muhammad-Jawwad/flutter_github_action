name: 2️⃣ Auto GitHub Release

on:
  push:
    # Trigger immediately when a push happens to any release branch
    branches:
      - 'release/*.*.*'

jobs:
  create_release:
    runs-on: ubuntu-latest
    
    # Use the PAT_TOKEN for the overall job environment, which all steps will use
    env:
      GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
    
    permissions:
      contents: write # Needed to create the release
      
    steps:
      - name: Extract Version from Branch Name
        id: extract_version
        run: |
          # The branch ref is e.g., refs/heads/release/0.0.9
          BRANCH_REF="${{ github.ref }}"
          # Removes 'refs/heads/' and 'release/' to get just the version number
          VERSION_NUMBER="${BRANCH_REF#refs/heads/release/}"
          # Removes the 'release/' prefix if present (in case of tag or other ref)
          VERSION_NUMBER="${VERSION_NUMBER#release/}"
          
          # Output the version number
          echo "VERSION_NUMBER=$VERSION_NUMBER" >> $GITHUB_OUTPUT

      - name: Generate Release Notes
        id: generate_notes
        uses: actions/github-script@v6
        
        # Token is picked up automatically from the job's 'env' block (GITHUB_TOKEN)
        with:
          script: |
            const newTagName = `v${process.env.VERSION_NUMBER}`;

            // API call to generate notes based on the current tag and the latest release
            const { data } = await github.rest.repos.generateReleaseNotes({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: newTagName,
              target_commitish: context.sha,
            });

            // Set the generated body as a step output
            core.setOutput('release_body', data.body);
        env:
          VERSION_NUMBER: ${{ steps.extract_version.outputs.VERSION_NUMBER }}

      - name: Create GitHub Release (Draft)
        uses: softprops/action-gh-release@v1
        
        # Token is automatically picked up from the job's 'env' block (GITHUB_TOKEN)

        with:
          # The release tag (e.g., v0.0.9)
          tag_name: "v${{ steps.extract_version.outputs.VERSION_NUMBER }}"
          
          # The release name (e.g., v0.0.9)
          name: "v${{ steps.extract_version.outputs.VERSION_NUMBER }}"
          
          # The target commitish is the branch itself
          target_commitish: ${{ github.ref_name }}
          
          # Set as a draft
          # draft: true 
          
          # Use the generated body from the previous step
          body: ${{ steps.generate_notes.outputs.release_body }}