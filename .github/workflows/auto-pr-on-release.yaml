name: Auto PR on Release Branch

on:
  push:
    branches:
      - 'release/*'

jobs:
  create_pr:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create Pull Request via GitHub API
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
        run: |
          echo "Creating PR from $BRANCH -> develop"

          # Create the JSON payload
          DATA=$(jq -n \
            --arg title "Merge $BRANCH into develop" \
            --arg head "$BRANCH" \
            --arg base "develop" \
            --arg body "Auto-generated PR from $BRANCH." \
            '{title: $title, head: $head, base: $base, body: $body}')

          # Make the API request
          response=$(curl -s -o response.json -w "%{http_code}" \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/$REPO/pulls \
            -d "$DATA")

          echo "Response code: $response"
          echo "API response:"
          cat response.json

          # If response code is not 201, fail the job
          if [ "$response" -ne 201 ]; then
            echo "❌ Failed to create PR"
            exit 1
          fi

          echo "✅ Pull Request created successfully!"